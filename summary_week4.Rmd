---
title: "Quick summary"
author: "Pablo Paulsen"
date: "06/12/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(fig.width=9, fig.height=6) 
library(tidyverse)
library(quantmod)
library(forecast)
library(tseries)
```

```{r functions, include = FALSE}
HDD = function (data, temp = 16) {
  mon_sum = data.frame(Year = NA, Month = NA, HDD = NA)[-1,]
  for (y in min(data$Year):max(data$Year)){
    for (m in min(data[data$Year == y,]$Month):max(data[data$Year == y,]$Month)) {
      #print(paste(y," ", m))
      adj_temps = -data[data$Year == y & data$Month == m,]$Temp+temp
      #print(sum(adj_temps*(adj_temps > 0))/24)
      mon_sum[nrow(mon_sum) + 1,] = c(y,m, sum(adj_temps*(adj_temps > 0))/24)
    }
  }
  mon_sum$City = data$City[1]
  return(mon_sum)
}

CDD = function (data, temp = 22) {
  mon_sum = data.frame(Year = NA, Month = NA, CDD = NA)[-1,]
  for (y in min(data$Year):max(data$Year)){
    for (m in min(data[data$Year == y,]$Month):max(data[data$Year == y,]$Month)) {
      #print(paste(y," ", m))
      adj_temps = data[data$Year == y & data$Month == m,]$Temp-temp
      #print(sum(adj_temps*(adj_temps > 0))/24)
      mon_sum[nrow(mon_sum) + 1,] = c(y,m, sum(adj_temps*(adj_temps > 0))/24)

    }
  }
  mon_sum$City = data$City[1]

  return(mon_sum)
}
avg_temp = function(data) {
  avg_temp = data %>% 
    group_by(Year, Month, City) %>% 
    summarise(avg_temp = mean(Temp))
  return(avg_temp)
}

yearly_line = function(period = 12, count = 10) {
  for (i in 0:count) {
    abline(v = i*period+1, lty = 3)
  }
}
```


Load in and set up all of the data. Data loaded in includes
\begin{itemize}
  \item Flip the fleet EV monitoring data with PHEVs removed. Includes monthly stats on the EV including distance traveled, efficiency and region of the vehicle. also only using data from 2017 as 2015 only included data from 5 cars and by the end of 2016 only included 23 cars.
  \item Weather data from
  \begin{itemize}
    \item Auckland
    \item Upper Hutt
    \item Christchurch
    \item Dunedin
    \item Hamilton
    \item Rotorua
    \item Nelson
    \item Palmerston North
    \item Stratford
    \item Napier
    \item Invercargill
  \end{itemize}
\end{itemize}

Using the weather data I calculated the regional average temperature for the month, heating degree days and cooling degree days using base temperature of 16 and 22 respectively. Base temperature is based around what is comfortable for most people as ( https://www.geotab.com/blog/ev-range/ ) research shows that a majority of the seasonal variation in EV efficiency is due to cabin temperature control. The base temps could be changed slightly or possibly even use cross validation to find the ideal for best model fit.

I then added the calculated monthly weather statistics by region to the monthly EV data based on the regions of vehicle. Assuming that vehicle stays in it own region for a majority of the time. 

I also created a quick monthly average for all of NZ and also by region of the EV statistics.

```{r data_setup, message = FALSE}
month_length = c(31,28,31,30,31,30,31,31,30,31,30,31)
#list index (first) is the location weather to use and value (second) is the region in the data 
weather_regions = list("Auckland" = "Auckland", "Upper Hutt" = "Wellington","Christchurch" = "Christchurch", "Dunedin" = "Coastal Otago", "Hamilton" = "Waikato", "Rotorua" = "Bay of Plenty","Christchurch" = "Mid Canterbury", "Christchurch" = "North Canterbury", "Christchurch" = "South Canterbury", "Clyde" = "Central Otago", "Nelson" = "Nelson", "Auckland" = "Whangarei", "Auckland" = "Far North", "Upper Hutt" = "Wairarapa", "Auckland" = "Rodney", "Dunedin" = "Waitaki", "Nelson" = "Golden Bay",  "Auckland" = "Coromandel", "Palmerston North" = "Manawatu", "Nelson" = "Marlborough", "Stratford" = "Taranaki", "Napier" = "Hawkes Bay", "Invercargill" = "Southland")



#main EV data
EV_data = read.csv('../Ftf Efficiency Dataset/ftf_ev_efficiency_distance_models_20211006_v1.0.csv', stringsAsFactors = T)[-1]
EV_data$weather_region = as.factor(names(weather_regions)[match(EV_data$region,  weather_regions)])

#sort factor by popularity
region_pop = EV_data %>%
  group_by(weather_region) %>% 
  summarise(count =  n_distinct(vehicle)) %>% 
  arrange(-count)
model_pop = EV_data %>%
  group_by(model) %>% 
  summarise(count =  n_distinct(vehicle)) %>% 
  arrange(-count)
EV_data$weather_region = factor(EV_data$weather_region, levels = region_pop$weather_region)
EV_data$model = factor(EV_data$model, levels = model_pop$model)
rm(region_pop)
rm(model_pop)

#remove PHEV
EV_data = EV_data[EV_data$model != "Mitsubishi Outlander" & EV_data$model != "Toyota Prius" & EV_data$model != "Mini Countryman PHEV", ]



#weather data
auckland_weather = read.csv('weather_data/auckland_motat_ews_data.csv',na.strings = "-",stringsAsFactors = T)
auckland_weather$Month = match(auckland_weather$Month, month.abb)
#Wellington does not have NIWA stations so closest is upperhutt
upperhutt_weather = read.csv('weather_data/upperhutt_trentham_ews_data.csv',na.strings = "-",stringsAsFactors = T)
upperhutt_weather$Month = match(upperhutt_weather$Month, month.abb)
christchurch_weather = read.csv('weather_data/christchurch_kyle_st_ews_data.csv',na.strings = "-", stringsAsFactors = T)
christchurch_weather$Month = match(christchurch_weather$Month, month.abb)
#use Dunedin weather for coastal Otago
dunedin_weather = read.csv('weather_data/dunedin_musselburgh_ews_data.csv',na.strings = "-",stringsAsFactors = T)
dunedin_weather$Month = match(dunedin_weather$Month, month.abb)
#use hamilton weather for Waikato
hamilton_weather = read.csv('weather_data/hamilton_ruakura_ews_data.csv', na.strings = "-", stringsAsFactors = T)
hamilton_weather$Month = match(hamilton_weather$Month, month.abb)
#use rotorua for bay of plenty
rotorua_weather = read.csv('weather_data/rotorua_ews_data.csv', na.strings = "-", stringsAsFactors = T)
rotorua_weather$Month = match(rotorua_weather$Month, month.abb)
#use clyde for central Otago
clyde_weather = read.csv('weather_data/clyde_ews_data.csv', na.strings = "-", stringsAsFactors = T)
clyde_weather$Month = match(clyde_weather$Month, month.abb)
nelson_weather = read.csv('weather_data/nelson_ews_data.csv', na.strings = "-", stringsAsFactors = T)
nelson_weather$Month = match(nelson_weather$Month, month.abb)
#use palmerston north for Manawatu
palmerston_weather = read.csv('weather_data/palmerston_north_ews_data.csv', na.strings = "-", stringsAsFactors = T)
palmerston_weather$Month = match(palmerston_weather$Month, month.abb)
#use stratford for Taranaki
stratford_weather = read.csv('weather_data/stratford_ews_data.csv', na.strings = "-", stringsAsFactors = T)
stratford_weather$Month = match(stratford_weather$Month, month.abb)
#use napier for Hawkes Bay
napier_weather = read.csv('weather_data/napier_ews_data.csv', na.strings = "-", stringsAsFactors = T)
napier_weather$Month = match(napier_weather$Month, month.abb)
#use invercargill for southland
invercargill_weather = read.csv('weather_data/invercargill_ews_data.csv', na.strings = "-", stringsAsFactors = T)
invercargill_weather$Month = match(invercargill_weather$Month, month.abb)

#temp calculations
HDD_data = Reduce(rbind, list(HDD(auckland_weather), HDD(upperhutt_weather), HDD(christchurch_weather),
                HDD(dunedin_weather), HDD(hamilton_weather), HDD(rotorua_weather), HDD(clyde_weather),
                HDD(nelson_weather), HDD(palmerston_weather), HDD(stratford_weather), HDD(napier_weather),
                HDD(invercargill_weather)))
CDD_data = Reduce(rbind, list(CDD(auckland_weather), CDD(upperhutt_weather), CDD(christchurch_weather),
                CDD(dunedin_weather), CDD(hamilton_weather), CDD(rotorua_weather), CDD(clyde_weather),
                CDD(nelson_weather), CDD(palmerston_weather), CDD(stratford_weather), CDD(napier_weather),
                CDD(invercargill_weather)))
avg_temp_data = Reduce(rbind, list(avg_temp(auckland_weather), avg_temp(upperhutt_weather), avg_temp(christchurch_weather),
                avg_temp(dunedin_weather), avg_temp(hamilton_weather), avg_temp(rotorua_weather), avg_temp(clyde_weather),
                avg_temp(nelson_weather), avg_temp(palmerston_weather), avg_temp(stratford_weather), avg_temp(napier_weather),
                avg_temp(invercargill_weather)))

EV_data = merge(EV_data, HDD_data, by.x = c("year", "month", "weather_region"), by.y = c("Year", "Month", "City"), all.x = T)
EV_data = merge(EV_data, CDD_data, by.x = c("year", "month", "weather_region"), by.y = c("Year", "Month", "City"), all.x = T)
EV_data = merge(EV_data, avg_temp_data, by.x = c("year", "month", "weather_region"), by.y = c("Year", "Month", "City"), all.x = T)

attach(EV_data)



#EV data with columns averaged by month
monthly_EV_data = EV_data[year >= 2017,] %>% 
  group_by(year, month) %>% 
  summarise(mean_kwh = mean(kwh), mean_dist = mean(distance), mean_ef = mean(efficiency))
monthly_EV_data$m = 1:nrow(monthly_EV_data)

#EV data with columns averaged by month and weather region
monthly_reg_EV_data = EV_data[year >= 2017,] %>% 
  na.omit() %>% 
  group_by(year, month, weather_region) %>% 
  summarise(mean_kwh = mean(kwh), mean_dist = mean(distance), mean_ef = mean(efficiency),
            HDD = mean(HDD), CDD = mean(CDD), avg_temp = mean(avg_temp))

```
```{r eff_plot}
plot(monthly_EV_data$m, monthly_EV_data$mean_ef, type = 'l', xaxt = "n", xlab = "", ylab = "Mean efficiency of EVs (km/kWh)", main = "Time series of EV efficiencies")
axis(1,labels = paste(monthly_EV_data$year, monthly_EV_data$month, sep = "-"), at = monthly_EV_data$m, las = 2,srt = 35)
yearly_line()
```

Plotting monthly average efficiency for all of NZ we can see that there is a very clear seasonal trend.


Used 2 different methods or decomposition of the seasonal trend of efficiency.
\begin{itemize}
  \item Linear model with each month as an independent factor
  \begin{itemize}
    \item offers more control and flexibility (could add vehicle type etc in further analysis)
    \item shows confidence interval
    \item requires to define an arbitrary function that can fit to the overall trend to separate from seasonal trend
    \item least squares is sensitive to single large deviation that could just be outlier (such as lockdown)
  \end{itemize}
  \item Time series Decomposition
  \begin{itemize}
    \item designed for time series
    \item automatically finds a overall trend based on the period to isolate the seasonal trend from
    \item less sensitive to a large deviation (such as lockdown) as attributed to noise compared to linear model
    \item no confidence interval
  \end{itemize}
\end{itemize}

In the end seems better to use Time series Decomposition for overall efficiency trend but is still useful to see from the linear model without assuming any correlation between the months it still has very strong confidence intervals (p-value $< 2^{-16}$). Could be worth doing some more in depth using linear model and modeling by car.

The decomposition shows that the seasonal trend goes from 0.93 times the efficiency in June to 1.025 the average efficiency in February in March


```{r eff_decomp_plot, message = FALSE, warning=FALSE}
eff_series = ts(monthly_EV_data$mean_ef, frequency = 12, start = 2017)
decomp_eff = decompose(eff_series,"multiplicative")
#base r plot commented out
#plot(decomp_eff)
#yearly_line(period = 1, 2100)
# Get the time values for the time series


Time = attributes(eff_series)$tsp
Time = seq(Time[1],Time[2], length.out=(Time[2]-Time[1])*Time[3])

# Convert td to data frame
dat = cbind(Time, with(decomp_eff, data.frame(Observed=x, Trend=trend, Seasonal=seasonal, Random=random)))

ggplot(gather(dat, component, value, -Time), aes(Time, value)) +
  facet_grid(component ~ ., scales="free_y") +
  geom_line() +
  labs(y="Efficiency", x="Year") +
  ggtitle("Decomposition of multiplicative efficiency time series")+
  theme(plot.title=element_text(hjust=0.5))+
  theme_bw()
  
```



