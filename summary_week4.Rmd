---
title: "Quick summary"
author: "Pablo Paulsen"
date: "06/12/2021"
output: pdf_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(fig.width=9, fig.height=5) 
library(tidyverse)
library(quantmod)
library(forecast)
library(tseries)
library(knitr)
rm(list=ls())
```

```{r functions, include = FALSE}
source("functions/yearly_line.R")
source("functions/plot_ts_decomp.R")
```

```{r ev_data_setup, message = FALSE}
load("processed_data/EV_weather_data.rda")
attach(EV_data)
```

## Introduction

This projects aims to understand how current seasonal trends in driving behavior coupled with seasonal differences in the driving efficiency of electric vehicles (EVs) will impact New Zealand's electricity grid under a future scenario where light vehicles are largely electrified. 

## Methodology

A variety of data sources were used. Distance traveled and vehicle efficiency (km/kWh) by month, as well as the region of the vehicle was collected from the on-board computers of `r length(unique(EV_data$vehicle))` vehicles between `r min(EV_data$year)` and `r max(EV_data$year)` as part of the 'Flip the Fleet' project.

Weather data was then collected from `r length(unique(names(weather_regions)))` regions around New Zealand that best correspond to the regions of the vehicles. 

Using the regional average temperatures, monthly heating degree days and cooling degree days were imputed using base temperatures of 16$^\circ$C and 22$^\circ$C respectively.  The base temperatures were selected to represent the range of comfortable temperatures for most people, as research \cite{ev_range} shows that a majority of the seasonal variation in EV efficiency is due to cabin temperature control. The base temperatures could be changed slightly or possibly even use cross validation to find the ideal for best model fit. 

The HDD and CDD was then divided by the length of the month so that HDD and CDD corresponds to average heating degrees days per day for the month. This is so that when comparing to other statistic such as efficiency that are averaged out rather than summed there is less bias

The calculated monthly weather statistics by region was then added to the monthly EV data based on the regions of vehicle. This assumes that vehicle stays in it's own region for a majority of the time. 

A monthly average was then created for all of NZ and also by region of the EV statistics.

## Results

```{r eff_plot}
plot(monthly_EV_data$m, monthly_EV_data$mean_ef, type = 'l', xaxt = "n", xlab = "", ylab = "Mean efficiency of EVs (km/kWh)", main = "Time series of EV efficiencies")
axis(1,labels = paste(monthly_EV_data$year, monthly_EV_data$month, sep = "-"), at = monthly_EV_data$m, las = 2,srt = 35)
yearly_line()
```


Plotting monthly average efficiency for all of NZ we can see that there is a very clear seasonal trend.


Used 2 different methods of decomposition of the seasonal trend of efficiency.
\begin{itemize}
  \item Linear model with each month as an independent factor
  \begin{itemize}
    \item offers more control and flexibility (could add vehicle type etc in further analysis)
    \item shows confidence interval
    \item requires to define an arbitrary function that can fit to the overall trend to separate from seasonal trend
    \item least squares is sensitive to single large deviation that could just be outlier (such as lockdown)
  \end{itemize}
  \item Time series Decomposition
  \begin{itemize}
    \item designed for time series
    \item automatically finds a overall trend based on the period to isolate the seasonal trend from
    \item less sensitive to a large deviation (such as lockdown) as attributed to noise compared to linear model
    \item no confidence interval
  \end{itemize}
\end{itemize}

In the end seems better to use Time series Decomposition for overall efficiency trend but is still useful to see from the linear model without assuming any correlation between the months it still has very strong confidence intervals (p-value $< 2^{-16}$). Could be worth doing some more in depth using linear model and modeling by car.

The decomposition shows that the seasonal trend goes from 0.93 times the mean efficiency in June to 1.025 the mean efficiency in February and March, A difference of 10%.




```{r eff_decomp_plot, message = FALSE, warning=FALSE, fig.height=6}
decomp_eff = monthly_EV_data$mean_ef %>% 
  ts(frequency = 12, start = 2017) %>% 
  decompose("multiplicative")

plot_decomp(decomp_eff, title = "Decomposition of Multiplicative Efficiency Time Series", ylab = "Efficiency")

```

Looking at the plot below there is a very obvious seasonal trend to EV efficiency but so that I can compare it to HDD I limit this to just Auckland EVs.

Within Auckland looking at the plot it is very obvious that as number of heating degree days increases the efficiency of the EV decreases. I do notice a slight dip in efficiency during Jan and Feb and it can be questioned if that is due to AC usage which would decrease range \cite{ev_range} or other factors such as holiday travel which could involve highway driving which EVs are generally less efficient at \cite{ev_highway}. This effect is not obvious in the overall trend this could be as Auckland for the most part is a warmer climate than the rest of NZ.


```{r eff_HDD_plot, warning=FALSE}
auck_eff_series = ts(monthly_reg_EV_data$mean_ef[which(monthly_reg_EV_data$weather_region == "Auckland")], frequency = 12)
decomp_auck_eff = decompose(auck_eff_series,"multiplicative")
auck_HDD_series = ts(monthly_reg_EV_data$HDD[monthly_reg_EV_data$weather_region == "Auckland"], frequency = 12)
decomp_auck_HDD = decompose(auck_HDD_series,"multiplicative")

par(mar = c(4, 4, 2, 4))
plot(decomp_auck_eff$figure, type = 'b', main = "Auckland Seasonal component Decompostions", xaxt = "n",
     xlab = "", ylab = "Change in efficiency")
axis(1, labels = month.abb, at = 1:12, las = 3)

par(new=TRUE)
plot(decomp_auck_HDD$figure, type = 'b', col = 2, xlab="", ylab="",axes=FALSE)
mtext("Average Heating Degree (° Days per Day) (Base temp 16°C)",side=4,line=2, cex = 1) 
axis(4)

legend("topright", legend = c("EV efficiency", "HDD"), lty = 1, col = 1:2)
```

Further looking into this we can see that in Auckland as the average temperature of the month starts increasing past 17.5 there appears to be a trend towards decreasing EV efficiency. As stated before research \cite{ev_range} suggested AC also decreases efficiency of the EV. This made me think what if we include cooling degree days and heating degree days in analysis? This could also be useful to explain the points well below the trend line that may be from a month where there was both cold and warm days contributing to a high usage of cabin temperature control decreasing range but average temperature would not be able to show this. 

```{r temp_eff_plot, message=FALSE}
monthly_reg_EV_data[monthly_reg_EV_data$weather_region == "Auckland",] %>%
  ggplot(aes(avg_temp, mean_ef)) + geom_point() + geom_smooth(method = 'loess') +
  ggtitle("Auckland Monthly Efficiency by Temperature") +
  labs(y="Monthly Average Efficiency", x="Monthly Average Temperature")
```

A linear model is use to model efficiency by HDD and CDD.

A different intercept is used for each model of car as a majority of the variation in efficiency will be due to different vehicle models, therefore, including the model allows for much better model fit and smaller confidence intervals. A different intercept is also used for each weather region as a weather might be measured in a cold or hot section of region and also the region may have more or less hill/highway which could influence driving patterns impacting efficiency (for simplicity preferable if not included but model is much better fit if is included). However the Gradient of HDD term and CDD term is kept same for all regions and models as it this is the number we are trying to find to see how the number of HDD and CDD effect the efficiency of the EV. A baseline of Auckland and Nissan Leaf (24 kWh) 2013-2016 are used for the region and model as there is the most amount of data in them.

A linear model is used as with the correct base temperature the usage of power to warm/cool the cabin should be roughly linear to the HDD/CDD \cite{HDD_est}. Unfortunately, cars unlike houses or buildings are often only used at particular hours of the day for short period so this may break down or have more dependency towards the temperature at times such as the morning or evening commute hours. 

The HDD term suggests that as the average number of heating degree days per days increases by 1 the average efficiency of EVs for the month decreases by 0.103. With a p-value of $<2\times10^{-16}$ we are quite confident on this value. 

The CDD term suggests that as the average number of cooling degree days per days increases by 1 the average efficiency of EVs for the month decreases by 0.113. With a p-value of $8.61\times10^{-5}$ we are less confident on this value. This is likely as there is much less data in New Zealand regarding cooling degree days as NZ is a much cooler climate compared to where a lot of the other research on EVs is going on. 


```{r eff_lm_model}
eff_h_c_w_m_lm = lm(efficiency ~ HDD + CDD + weather_region + model, data = EV_data[year >=2017,], na.action=na.omit)
summary(eff_h_c_w_m_lm)
```


If we know that EVs are less efficient in the winter due to heating requirements and to a much lesser extent in NZ less efficient on warm days due to AC in order to see how this will affect the grid we need to see how this correlates with NZ populations driving pattern. 

Currently waiting on Haobo from NZTA for VKT estimate data which would be ideal. 

For now I have 3 data sets regarding fuel usage
\begin{itemize}
  \item monthly card sales data 
  \begin{itemize}
    \item monthly data for all of NZ credit card transactions at fuel stations
  \end{itemize}
  \item quarterly regional fuel sales data
  \begin{itemize}
    \item quarterly data for all sales at fuel stations broken down by region from MBIE
  \end{itemize}
  \item quarterly fuel trade data
    \begin{itemize}
    \item quarterly data of fuel used for transport by type of fuel
  \end{itemize}
\end{itemize}

As an initial analysis of the fuel usage in NZ I load the quarterly regional fuel sales data so that I can isolate only petrol usage in domestic land transport which should be a accurate representation of the fuel usage by passenger cars. Will be just combining regular petrol and premium for analysis. (Premium used to be more popular. Was there a definition change on premium and regular used in the data?)


```{r fuel_data}
#MBIE quaterly fuel usage data
fuel_trade = read.csv("downloaded_stats/fuel_trade.csv", header = T)
fuel_trade$qart = fuel_trade$month/3
```

```{r petrol_ts, warning=FALSE, message=FALSE}
decomp_petrol = fuel_trade$Petrol[fuel_trade$year < 2020] %>% 
  ts(frequency = 4, start = min(fuel_trade$year)) %>% 
  decompose("multiplicative")
  

plot_decomp(decomp_petrol, title = "Decomposition of Multiplicative Petrol Usage Time Series", ylab = "Fuel usage (L)")
```

I excluded the fuel data from 2020 as lockdowns were not an accurate representation of the general driving patterns of the NZ population. Looking at the decomposition above there is a clear seasonal trend however it not that significant and is smaller than the larger deviations of the random variations. 

looking at the seasonal trend of fuel usage plotted against the change in efficiency below we can see that the Petrol usage actually tends to decrease when EV efficiency decreases. Assuming Petrol usage corresponds to VKT (Petrol vehicle efficiency does not change significantly by season) this suggests that the effect of winter decrease in efficiency on the electricity grid may be offset by the decrease in total VKT.

```{r petrol_vs_eff}
par(mar = c(4, 4, 2, 4))
plot(decomp_eff$figure, type = 'b', main = "NZ Seasonal Component Decompostions", xaxt = "n",
     xlab = "", ylab = "Change in Efficiency")
axis(1, labels = month.abb, at = 1:12, las = 3)

points(unique(fuel_trade$month),decomp_petrol$figure, type = 'b', col = 2, xlab="", ylab="")
mtext("Change in Petrol usage",side=4,line=2, cex = 1, col = 2) 
axis(4, col = 2)

legend("bottomright", legend = c("EV efficiency", "Petrol Usage"), lty = 1, col = 1:2)
```

In order to get a regional estimate I would need more data or make the assumption that all regions have equal petrol vs diesel usage which is unlikely to be true. Currently waiting on data from NZTA on VKT, Auckland city council and Wellington city council on fuel tax.





\begin{thebibliography}{9}
\bibitem{ev_range}
\textit{To what degree does temperature impact EV range?}
\\\texttt{\url{https://www.geotab.com/blog/ev-range/}}
\bibitem{ev_highway}
\textit{Why is the range of an EV less on the freeway than the city?}
\\\texttt{\url{https://evcentral.com.au/why-is-the-range-of-an-ev-less-on-the-freeway-than-the-city/}}
\bibitem{HDD_est}
\textit{Bayesian estimation of a building's base temperature for the calculation of heating degree-days}
\\\texttt{https://www.sciencedirect.com/science/article/abs/pii/S0378778816312907}
\end{thebibliography}