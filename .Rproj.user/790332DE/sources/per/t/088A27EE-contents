---
title: "Useful findings"
author: "pablo paulsen"
date: "23/11/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(fig.width=9, fig.height=5) 
library(dplyr)
library(ggplot2)
library(tidyr)
library(quantmod)
library(forecast)
library(tseries)
```

```{r functions}
HDD = function (data, temp = 16) {
  mon_sum = data.frame(Year = NA, Month = NA, HDD = NA)[-1,]
  for (y in min(data$Year):max(data$Year)){
    for (m in min(data[data$Year == y,]$Month):max(data[data$Year == y,]$Month)) {
      #print(paste(y," ", m))
      adj_temps = -data[data$Year == y & data$Month == m,]$Temp+temp
      #print(sum(adj_temps*(adj_temps > 0))/24)
      mon_sum[nrow(mon_sum) + 1,] = c(y,m, sum(adj_temps*(adj_temps > 0))/24)
    }
  }
  mon_sum$City = data$City[1]
  return(mon_sum)
}

CDD = function (data, temp = 16) {
  mon_sum = data.frame(Year = NA, Month = NA, CDD = NA)[-1,]
  for (y in min(data$Year):max(data$Year)){
    for (m in min(data[data$Year == y,]$Month):max(data[data$Year == y,]$Month)) {
      #print(paste(y," ", m))
      adj_temps = data[data$Year == y & data$Month == m,]$Temp-temp
      #print(sum(adj_temps*(adj_temps > 0))/24)
      mon_sum[nrow(mon_sum) + 1,] = c(y,m, sum(adj_temps*(adj_temps > 0))/24)

    }
  }
  mon_sum$City = data$City[1]

  return(mon_sum)
}

yearly_line = function(period = 12, count = 10) {
  for (i in 1:count) {
    abline(v = i*period, lty = 3)
  }
}
```


```{r data_setup, message = FALSE}
month_length = c(31,28,31,30,31,30,31,31,30,31,30,31)
weather_regions = list("Auckland" = "Auckland", "Upper Hutt" = "Wellington","Christchurch" = "Christchurch", "Dunedin" = "Coastal Otago", "Hamilton" = "Waikato", "Rotorua" = "Bay of Plenty","Christchurch" = "Mid Canterbury", "Christchurch" = "North Canterbury", "Christchurch" = "South Canterbury")


#main EV data
EV_data = read.csv('../Ftf Efficiency Dataset/ftf_ev_efficiency_distance_models_20211006_v1.0.csv', stringsAsFactors = T)[-1]
EV_data$weather_region = names(weather_regions)[match(EV_data$region,  weather_regions)]

attach(EV_data)



#EV data with columns averaged by month
monthly_EV_data = EV_data[year >= 2017,] %>% 
  group_by(year, month) %>% 
  summarise(mean_kwh = mean(kwh), mean_dist = mean(distance), median_kwh = median(kwh), median_dist = median(distance), mean_ef = mean(efficiency))
monthly_EV_data$m = 1:nrow(monthly_EV_data)



#weather data
auckland_weather = read.csv('weather_data/auckland_motat_ews_data.csv',na.strings = "-",stringsAsFactors = T)
auckland_weather$Month = match(auckland_weather$Month, month.abb)
#Wellington does not have NIWA stations so closest is upperhutt
upperhutt_weather = read.csv('weather_data/upperhutt_trentham_ews_data.csv',na.strings = "-",stringsAsFactors = T)
upperhutt_weather$Month = match(upperhutt_weather$Month, month.abb)
christchurch_weather = read.csv('weather_data/christchurch_kyle_st_ews_data.csv',na.strings = "-", stringsAsFactors = T)
christchurch_weather$Month = match(christchurch_weather$Month, month.abb)
#use Dunedin weather for coastal Otago
dunedin_weather = read.csv('weather_data/dunedin_musselburgh_ews_data.csv',na.strings = "-",stringsAsFactors = T)
dunedin_weather$Month = match(dunedin_weather$Month, month.abb)
#use hamilton weather for Waikato
hamilton_weather = read.csv('weather_data/hamilton_ruakura_ews_data.csv', na.strings = "-", stringsAsFactors = T)
hamilton_weather$Month = match(hamilton_weather$Month, month.abb)
#use rotorua for bay of plenty
rotorua_weather = read.csv('weather_data/rotorua_ews_data.csv', na.strings = "-", stringsAsFactors = T)
rotorua_weather$Month = match(rotorua_weather$Month, month.abb)

heating_degree_days = Reduce(rbind, list(HDD(auckland_weather), HDD(upperhutt_weather), HDD(christchurch_weather),
                HDD(dunedin_weather), HDD(hamilton_weather), HDD(rotorua_weather)))

```

```{r}
EV_data %>%
  group_by(region, weather_region) %>% 
  summarise(count =  n_distinct(vehicle)) %>% 
  arrange(-count)
```


```{r}
plot(monthly_EV_data$m, monthly_EV_data$mean_ef, type = 'l', xaxt = "n", xlab = "", ylab = "Mean efficiency of EVs (km/kWh)", main = "Time series of EV efficiencies")
axis(1,labels = paste(monthly_EV_data$year, monthly_EV_data$month, sep = "-"), at = monthly_EV_data$m, las = 2,srt = 35)

yearly_line()
```
simple linear model with mean_eff $= t + \ln t + t^2 +$month (as factor). negative squared term means can not use for long term efficiency trend as it will got negative but allows it to better fit the seasonal trend


```{r}
monthly_eff_qm_log = lm(mean_ef ~ m+I(log(m))+I(m^2)+factor(month),data = monthly_EV_data)
summary(monthly_eff_qm_log)
```


```{r}
plot(monthly_EV_data$m, monthly_EV_data$mean_ef, type = 'l', xaxt = "n", xlab = "", ylab = "Mean efficiency of EVs (km/kWh)", main = "Time series of EV efficiencies")
lines(monthly_EV_data$m, predict(monthly_eff_qm_log), col = 'red', lty = 2)

yearly_line()
axis(1,labels = paste(monthly_EV_data$year, monthly_EV_data$month, sep = "-"), at = monthly_EV_data$m, las = 2,srt = 35)
legend("topleft", legend = c("Actual mean EV efficiency", "Modelled prediction EV efficiency"), lty = 1:2, col = 1:2)
```
```{r}
eff_series = ts(monthly_EV_data$mean_ef, frequency = 12)
adf.test(eff_series, alternative = "stationary")
```
we can reject null hypothesis that data is not-stationary. this makes sense as average efficiency should not have significantly changed in a couple of years. use multiplicative instead of additive as preferable to know estimated extra power use? or should i know total extra power used in season?


```{r}
#decomp_eff = decompose(eff_series, "multiplicative")
decomp_eff = decompose(eff_series,"additive")
plot(decomp_eff)
yearly_line(period = 1)
```

```{r}
plot(decomp_eff$figure, type = 'l', main = "Seasonal compontent of Efficiency of EV", xaxt = "n",
     xlab = "", ylab = "Change in efficiency (km/kWh)")
points(1:12, scale(c(0,monthly_eff_qm_log$coefficients[paste("factor(month)", 2:12, sep = "")]),scale = F),
       type = 'l', col = "red")
axis(1, labels = month.name, at = 1:12, las = 3)
legend("top", legend = c("Seasonal compontent Decompostion", 'Seasonal compontent of linear model'), lty = 1, col = 1:2)
```

